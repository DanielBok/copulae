import numpy as np
from numpy.testing import assert_allclose

from copulae.mixtures.gmc.marginals import gmm_marginal_cdf, gmm_marginal_ppf
from copulae.mixtures.gmc.param import GMCParam

param = GMCParam(3, 2,
                 prob=[0.48923563, 0.05350188, 0.45726249],
                 means=[
                     [-7.866836, -11.073276],
                     [-3.336661, 24.139628],
                     [-23.879568, -5.213695]
                 ],
                 covs=[
                     [[15.9705696, -0.27545926],
                      [-0.2754593, 0.01738696]],
                     [[3.973527, -2.588777],
                      [-2.588777, 6.676961]],
                     [[5.3549889, -0.3326589],
                      [-0.3326589, 4.8624179]]
                 ])


def test_gmm_marginal_cdf():
    x = np.array([[-3.677231992, 2.3490822],
                  [1.743806244, 1.6101606],
                  [-3.300399649, 1.8222931],
                  [-1.548997255, -1.7920712],
                  [-3.230406265, 3.6765432],
                  [1.247973969, 0.3122671],
                  [0.626518395, -1.2115218],
                  [-2.246109197, 4.8176366],
                  [-0.393638703, 0.1285267],
                  [0.004476217, 1.4794919]])

    actual = gmm_marginal_cdf(x, param)
    expected = [[0.8975912, 0.9463591],
                [0.9957476, 0.9460456],
                [0.9117104, 0.9461722],
                [0.9622472, 0.9188961],
                [0.9142214, 0.9464853],
                [0.9939016, 0.9437019],
                [0.9905330, 0.9305998],
                [0.9453356, 0.9464969],
                [0.9812174, 0.9429709],
                [0.9855323, 0.9459467]]

    assert_allclose(actual, expected)


def test_gmm_marginal_ppf():
    q = np.array([[0.47500534, 0.60472974],
                  [0.93067899, 0.17763292],
                  [0.35212585, 0.08556876],
                  [0.31126504, 0.50731277],
                  [0.4984078, 0.76740582],
                  [0.46674749, 0.83129661],
                  [0.17920184, 0.0830783],
                  [0.29490617, 0.74172201],
                  [0.15278869, 0.68946309],
                  [0.22882008, 0.97558944]])

    actual = gmm_marginal_ppf(q, param)
    expected = [[-15.040304, -6.683230],
                [-2.741889, -11.120678],
                [-22.170614, -11.198161],
                [-22.793233, -9.086236],
                [-13.373482, -4.607316],
                [-16.095925, -3.739740],
                [-24.514575, -11.200815],
                [-23.019905, -4.924568],
                [-24.871327, -5.558387],
                [-23.877367, 24.423672]]

    assert_allclose(actual, expected, atol=6)
